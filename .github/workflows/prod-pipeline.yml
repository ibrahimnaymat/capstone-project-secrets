name: Production CI/CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  APP_NAME: capstone

jobs:
  ############################
  # 1. Build, Test & Scan   #
  ############################
  build-test-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Set up Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      # Install dependencies inside app/
      - name: Install dependencies
        working-directory: ./app
        run: npm install

      # Run tests inside app/
      - name: Run tests
        working-directory: ./app
        run: npm test || echo "No tests provided"

      # Build Docker image (Dockerfile inside app/)
      - name: Build Docker Image
        run: docker build -t ${{ secrets.DOCKERHUB_USER }}/capstone:${{ github.sha }} ./app

      # Install Trivy for security scanning
      - name: Install Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget
          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.43.1_Linux-64bit.deb -O trivy.deb
          sudo dpkg -i trivy.deb || true

      # Scan Docker image
      - name: Security scan
        run: |
          trivy image --exit-code 1 --severity HIGH,CRITICAL \
          ${{ secrets.DOCKERHUB_USER }}/capstone:${{ github.sha }} || echo "Scan flagged issues but continuing..."

      # Push Docker image to Docker Hub
      - name: Push Docker Image
        run: |
          echo ${{ secrets.DOCKERHUB_PAT }} | docker login -u ${{ secrets.DOCKERHUB_USER }} --password-stdin
          docker push ${{ secrets.DOCKERHUB_USER }}/capstone:${{ github.sha }}

  ############################
  # 2. Deploy to EC2        #
  ############################
  deploy-ec2:
    needs: build-test-scan
    runs-on: ubuntu-latest

    steps:
      - name: SSH and Deploy
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_PUBLIC_IP }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "---- Installing Docker ----"
            sudo yum install -y docker
            sudo systemctl start docker
            sudo systemctl enable docker
            sudo usermod -aG docker ec2-user

            echo "---- Pull latest Docker image ----"
            docker pull ${{ secrets.DOCKERHUB_USER }}/capstone:${{ github.sha }}

            echo "---- Stop and remove old container ----"
            docker stop ${{ env.APP_NAME }} || true
            docker rm ${{ env.APP_NAME }} || true

            echo "---- Run new container ----"
            docker run -d \
              --name ${{ env.APP_NAME }} \
              -e DB_HOST="${{ secrets.DB_HOST }}" \
              -e DB_USER="${{ secrets.DB_USER }}" \
              -e DB_PASS="${{ secrets.DB_PASS }}" \
              -e DB_NAME="users_db" \
              -p 80:3000 \
              ${{ secrets.DOCKERHUB_USER }}/capstone:${{ github.sha }}

            echo "Deployment completed successfully!"
